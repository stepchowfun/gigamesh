image: ubuntu:18.04
tasks:
  install_dependencies:
    command: |
      set -euo pipefail
      apt-get update
      echo 'deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main' | tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
      apt-get install --yes apt-transport-https ca-certificates curl gnupg
      curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
      apt-get update
      apt-get install --yes google-cloud-sdk

  create_user:
    command: |
      set -euo pipefail
      adduser --disabled-password --gecos '' user

  deploy:
    dependencies:
      - create_user
      - install_dependencies
    cache: false
    environment:
      GCP_CREDENTIALS: none
    input_paths:
      - index.html
    user: user
    command: |
      set -euo pipefail
      export GOOGLE_APPLICATION_CREDENTIALS=~/gcp-credentials.json
      echo "$GCP_CREDENTIALS" > "$GOOGLE_APPLICATION_CREDENTIALS"
      gcloud auth activate-service-account --key-file "$GOOGLE_APPLICATION_CREDENTIALS"
      gsutil cp index.html "gs://www.gigamesh.io"
